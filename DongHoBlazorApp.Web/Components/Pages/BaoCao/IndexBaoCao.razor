@page "/BaoCao"
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
<PageTitle>Trang chủ báo cáo</PageTitle>

<!-- Main Content -->
<div class="main-content">
    <header class="top-header">
        <div class="header-left">
            <h1>Báo Cáo & Thống Kê</h1>
            <p class="breadcrumb">Trang Chủ / Báo Cáo</p>
        </div>
        <div class="header-right">
            <select class="filter-select" @onchange="OnFilterChanged" value="@SelectedFilter">
                <option value="7 ngày qua">7 ngày qua</option>
                <option value="30 ngày qua">30 ngày qua</option>
                <option value="Tháng này">Tháng này</option>
                <option value="Quý này">Quý này</option>
                <option value="Năm nay">Năm nay</option>
            </select>
            <button class="btn btn-primary">📥 Xuất Báo Cáo</button>
        </div>
    </header>

    @if (IsLoading)
    {
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
        </div>
    }
    else if (ReportData != null)
    {
        <!-- Revenue Chart -->
        <div class="card chart-card" style="margin-bottom: 30px;">
            <div class="card-header">
                <h3>Doanh Thu Theo Tháng</h3>
                <div style="display: flex; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #667eea; border-radius: 3px;"></div>
                        <span style="color: #95a5a6; font-size: 14px;">Doanh thu</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #38ef7d; border-radius: 3px;"></div>
                        <span style="color: #95a5a6; font-size: 14px;">Lợi nhuận</span>
                    </div>
                </div>
            </div>
            <div class="chart-placeholder">
                <div class="bar-chart">
                    @foreach (var item in ReportData.RevenueByMonth)
                    {
                        var maxVal = ReportData.RevenueByMonth.Max(x => x.Revenue);
                        var revHeight = maxVal > 0 ? (int)(item.Revenue / maxVal * 100) : 0;
                        var profitHeight = maxVal > 0 ? (int)(item.Profit / maxVal * 100) : 0;

                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1; height: 100%;">
                            <div style="display: flex; width: 100%; height: 100%; align-items: flex-end; gap: 5px;">
                                <div style="flex: 1; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); border-radius: 5px 5px 0 0; height: @($"{revHeight}%");" title="@(item.Revenue.ToString("N0") + " ₫")"></div>
                                <div style="flex: 1; background: linear-gradient(180deg, #11998e 0%, #38ef7d 100%); border-radius: 5px 5px 0 0; height: @($"{profitHeight}%");" title="@(item.Profit.ToString("N0") + " ₫")"></div>
                            </div>
                            <span style="margin-top: 10px; font-size: 12px; color: #95a5a6;">@item.Month</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <!-- Sales by Brand -->
            <div class="card">
                <div class="card-header">
                    <h3>Doanh Số Theo Thương Hiệu</h3>
                </div>
                <div style="padding: 20px 0;">
                    @foreach (var (item, index) in ReportData.SalesByBrand.Select((v, i) => (v, i)))
                    {
                        string[] colors = { "#667eea", "#0072ff", "#38ef7d", "#f5576c", "#95a5a6" };
                        string color = index < colors.Length ? colors[index] : "#95a5a6";

                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #2c3e50; font-weight: 600;">@item.BrandName</span>
                                <span style="color: @color; font-weight: 600;">@item.Percentage%</span>
                            </div>
                            <div style="height: 10px; background: #e1e8ed; border-radius: 10px; overflow: hidden;">
                                <div style="width: @($"{item.Percentage}%"); height: 100%; background: @color;"></div>
                            </div>
                        </div>
                    }
                    @if (!ReportData.SalesByBrand.Any())
                    {
                        <p style="text-align: center; color: #95a5a6;">Không có dữ liệu</p>
                    }
                </div>
            </div>

            <!-- Top Customers -->
            <div class="card">
                <div class="card-header">
                    <h3>Top Khách Hàng</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    @foreach (var (customer, index) in ReportData.TopCustomers.Select((v, i) => (v, i)))
                    {
                        string[] gradients = {
                            "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                            "linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)",
                            "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)",
                            "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
                        };
                        string gradient = index < gradients.Length ? gradients[index] : gradients[0];

                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e1e8ed; border-radius: 10px;">
                            <div style="width: 45px; height: 45px; background: @gradient; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">@(index + 1)</div>
                            <div style="flex: 1;">
                                <h4 style="color: #2c3e50; font-size: 15px; margin-bottom: 3px;">@customer.CustomerName</h4>
                                <p style="color: #95a5a6; font-size: 13px;">@customer.OrderCount đơn hàng</p>
                            </div>
                            <div style="color: #667eea; font-size: 16px; font-weight: 600;">@(customer.TotalSpent.ToString("N0") + " ₫")</div>
                        </div>
                    }
                    @if (!ReportData.TopCustomers.Any())
                    {
                        <p style="text-align: center; color: #95a5a6;">Không có dữ liệu khách hàng</p>
                    }
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="card">
            <div class="card-header">
                <h3>Chỉ Số Hiệu Suất</h3>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="padding: 20px; border: 2px solid #667eea; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <p style="color: #95a5a6; font-size: 14px; margin-bottom: 8px;">Tỷ Lệ Chuyển Đổi</p>
                            <h3 style="color: #2c3e50; font-size: 28px; margin: 0;">@ReportData.PerformanceMetrics.ConversionRate%</h3>
                        </div>
                        <span style="font-size: 32px;">📊</span>
                    </div>
                </div>
                <div style="padding: 20px; border: 2px solid #0072ff; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <p style="color: #95a5a6; font-size: 14px; margin-bottom: 8px;">Giá Trị ĐH Trung Bình</p>
                            <h3 style="color: #2c3e50; font-size: 28px; margin: 0;">@(ReportData.PerformanceMetrics.AverageOrderValue.ToString("N0") + " ₫")</h3>
                        </div>
                        <span style="font-size: 32px;">💰</span>
                    </div>
                </div>
                <div style="padding: 20px; border: 2px solid #38ef7d; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <p style="color: #95a5a6; font-size: 14px; margin-bottom: 8px;">Tỷ Lệ Hoàn Thành</p>
                            <h3 style="color: #2c3e50; font-size: 28px; margin: 0;">@ReportData.PerformanceMetrics.CompletionRate%</h3>
                        </div>
                        <span style="font-size: 32px;">✅</span>
                    </div>
                </div>
                <div style="padding: 20px; border: 2px solid #f5576c; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <p style="color: #95a5a6; font-size: 14px; margin-bottom: 8px;">Thời Gian Xử Lý TB</p>
                            <h3 style="color: #2c3e50; font-size: 28px; margin: 0;">@($"{ReportData.PerformanceMetrics.AverageProcessingTime}h")</h3>
                        </div>
                        <span style="font-size: 32px;">⏱️</span>
                    </div>
                </div>
            </div>
        </div>
    }
</div>