@page "/TaoDonHang"
@using DongHoBlazorApp.Model.Entities

<PageTitle>Tạo Đơn Hàng Mới</PageTitle>

<div class="main-content">
    <header class="top-header">
        <div class="header-left">
            <h1>Tạo Đơn Hàng Mới</h1>
            <p class="breadcrumb">Đơn Hàng / Tạo Mới</p>
        </div>
        <div class="header-right">
            <button class="btn btn-outline" @onclick="@(() => NavigationManager.NavigateTo("/DonHang"))">
                <span>✕</span> Hủy Bỏ
            </button>
            <button class="btn btn-primary" @onclick="HandleSubmit">
                <span>✓</span> Tạo Đơn Hàng
            </button>
        </div>
    </header>

    <div class="create-grid">
        <!-- Thông Tin Chung -->
        <div class="card">
            <div class="card-header">
                <h3>Thông Tin Chung</h3>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Mã Đơn Hàng</label>
                    <input type="text" class="form-control" value="Sẽ được tạo tự động" disabled>
                </div>
                <div class="form-group">
                    <label>Ngày Đặt</label>
                    <input type="date" class="form-control" @bind="Order.NgayDat">
                </div>
                <div class="form-group">
                    <label>Trạng Thái</label>
                    <select class="form-control" @bind="Order.TinhTrang">
                        <option value="Đang xử lý">Đang xử lý</option>
                        <option value="Đã xác nhận">Đã xác nhận</option>
                        <option value="Đang giao">Đang giao</option>
                        <option value="Hoàn thành">Hoàn thành</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Thanh Toán</label>
                    <select class="form-control" @bind="Order.DaThanhToan">
                        <option value="false">Chưa thanh toán</option>
                        <option value="true">Đã thanh toán</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Khách Hàng -->
        <div class="card">
            <div class="card-header">
                <h3>Khách Hàng</h3>
            </div>
            <div class="customer-search-section">
                <div class="search-input-wrapper" style="position: relative;">
                    <input type="text" class="form-control" placeholder="Tìm tên, SĐT hoặc email khách hàng..." 
                           @oninput="HandleCustomerSearch" @bind-value="CustomerSearchTerm">
                    
                    @if (ShowCustomerResults)
                    {
                        <div class="search-results-dropdown">
                            @foreach (var customer in CustomerSearchResults)
                            {
                                <div class="search-result-item" @onclick="() => SelectCustomer(customer)">
                                    <div class="res-info">
                                        <strong>@customer.TenKH</strong>
                                        <span>@customer.SoDienThoai | @customer.Email</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                @if (SelectedCustomer != null)
                {
                    <div class="selected-customer-info">
                        <div class="customer-avatar">@SelectedCustomer.TenKH[0]</div>
                        <div class="customer-details">
                            <h4>@SelectedCustomer.TenKH</h4>
                            <p>@SelectedCustomer.SoDienThoai</p>
                            <p>@SelectedCustomer.Email</p>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Địa Chỉ Giao Hàng -->
        <div class="card full-width">
            <div class="card-header">
                <h3>Địa Chỉ Giao Hàng</h3>
            </div>
            <div class="form-grid-3">
                <div class="form-group">
                    <label>Địa Chỉ Chi Tiết</label>
                    <input type="text" class="form-control" placeholder="Số nhà, tên đường..." @bind="Order.DiaChiGiaoHang">
                </div>
                <div class="form-group">
                    <label>Ngày Giao Dự Kiến</label>
                    <input type="date" class="form-control" @bind="Order.NgayGiao">
                </div>
                <div class="form-group">
                    <label>Ghi Chú</label>
                    <textarea class="form-control" placeholder="Lưu ý cho người giao hàng..." rows="1"></textarea>
                </div>
            </div>
        </div>

        <!-- Chi Tiết Sản Phẩm -->
        <div class="card full-width">
            <div class="card-header">
                <h3>Chi Tiết Sản Phẩm</h3>
                <button class="btn btn-secondary btn-sm" @onclick="AddRow">+ Thêm Sản Phẩm</button>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th width="50px">STT</th>
                            <th>Sản Phẩm</th>
                            <th width="150px">Số Lượng</th>
                            <th width="200px">Đơn Giá</th>
                            <th width="200px">Thành Tiền</th>
                            <th width="80px">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < OrderItems.Count; i++)
                        {
                            var index = i;
                            var item = OrderItems[index];
                            <tr>
                                <td>@(index + 1)</td>
                                <td>
                                    <div class="product-search-cell" style="position: relative;">
                                        <input type="text" class="form-control" placeholder="Tìm sản phẩm..." 
                                               @bind-value="item.ProductName"
                                               @oninput="(e) => HandleProductSearch(index, e)">
                                        
                                        @if (ActiveRowIndex == index && ProductSearchResults.Any())
                                        {
                                            <div class="search-results-dropdown">
                                                @foreach (var prod in ProductSearchResults)
                                                {
                                                    <div class="search-result-item" @onclick="() => SelectProduct(index, prod)">
                                                        <div class="res-info">
                                                            <strong>@prod.TenDongHo</strong>
                                                            <span>Giá: @prod.GiaBan.ToString("#,### ₫") | Kho: @prod.SoLuongTon</span>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="qty-input">
                                        <button class="qty-btn" @onclick="() => { if(item.Quantity > 1) item.Quantity--; }">-</button>
                                        <input type="number" class="form-control text-center" @bind="item.Quantity">
                                        <button class="qty-btn" @onclick="() => item.Quantity++">+</button>
                                    </div>
                                </td>
                                <td>
                                    <input type="text" class="form-control" value="@item.UnitPrice.ToString("#,### ₫")" disabled>
                                </td>
                                <td>
                                    <strong>@item.Subtotal.ToString("#,### ₫")</strong>
                                </td>
                                <td>
                                    <button class="btn-delete" @onclick="() => RemoveRow(index)">🗑️</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Tổng Kết -->
            <div class="order-summary">
                <div class="summary-row">
                    <span>Tổng số lượng:</span>
                    <strong>@TotalQuantity</strong>
                </div>
                <div class="summary-row grand-total">
                    <span>Tổng cộng:</span>
                    <h2 class="price-text">@TotalAmount.ToString("#,### ₫")</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .search-results-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
    }

    .search-result-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background 0.2s;
    }

    .search-result-item:hover {
        background: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .res-info strong {
        display: block;
        color: #333;
    }

    .res-info span {
        font-size: 12px;
        color: #666;
    }

    .selected-customer-info {
        margin-top: 15px;
        padding: 15px;
        background: #f3f0ff;
        border-radius: 8px;
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .customer-avatar {
        width: 45px;
        height: 45px;
        background: #7c3aed;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }

    .customer-details h4 {
        margin: 0;
        color: #1f2937;
    }

    .customer-details p {
        margin: 0;
        font-size: 13px;
        color: #6b7280;
    }

    .price-text {
        color: #7c3aed;
        margin: 0;
    }

    .order-summary {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #f3f4f6;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
    }

    .summary-row {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .grand-total {
        margin-top: 5px;
    }

    .create-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .full-width {
        grid-column: span 2;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 50px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #7c3aed;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>